/**
 * Copyright (c) 2011 Richard Ian Taylor.
 *
 * This file is part of the iDroid Project. (http://www.idroidproject.org).
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License version 2 as
 * published by the Free Software Foundation.
 */

#include <linux/platform_device.h>
#include <linux/completion.h>
#include <linux/dma-mapping.h>

#include <asm/mach-types.h>

#include <plat/h2fmi.h>
#include <mach/map.h>
#include <mach/irqs.h>

static struct resource h2fmi0_res[] = {
	[0] = {
		.start = PA_FMI0,
		.end = PA_FMI0 + SZ_FMI0 -1,
		.flags = IORESOURCE_MEM,
	},
	[1] = {
		.start = PA_FMI1,
		.end = PA_FMI1 + SZ_FMI1 -1,
		.flags = IORESOURCE_MEM,
	},
	[2] = {
		.start = PA_FMI2,
		.end = PA_FMI2 + SZ_FMI2 -1,
		.flags = IORESOURCE_MEM,
	},
	[3] = {
		.start = IRQ_FMI0,
		.end = IRQ_FMI0,
		.flags = IORESOURCE_IRQ,
	},
};

static struct resource h2fmi1_res[] = {
	[0] = {
		.start = PA_FMI3,
		.end = PA_FMI3 + SZ_FMI3 -1,
		.flags = IORESOURCE_MEM,
	},
	[1] = {
		.start = PA_FMI4,
		.end = PA_FMI4 + SZ_FMI4 -1,
		.flags = IORESOURCE_MEM,
	},
	[2] = {
		.start = PA_FMI5,
		.end = PA_FMI5 + SZ_FMI5 -1,
		.flags = IORESOURCE_MEM,
	},
	[3] = {
		.start = IRQ_FMI1,
		.end = IRQ_FMI1,
		.flags = IORESOURCE_IRQ,
	},
};

static struct h2fmi_chip_info h2fmi_chip_info[] = {
#ifdef CONFIG_MACH_IPHONE_4
	{ { 0x7A94D7EC, 0x0, }, 0x1038, 0x80, 0x2000, 0x280, 0x10, 0, 8, 1, 0 },
	{ { 0x7AD5DEEC, 0x0, }, 0x2070, 0x80, 0x2000, 0x280, 0x10, 0, 8, 2, 0 },
	{ { 0x7294D7EC, 0x0, }, 0x1038, 0x80, 0x2000, 0x1B4, 0xC, 0, 8, 1, 0 },
	{ { 0x72D5DEEC, 0x0, }, 0x2070, 0x80, 0x2000, 0x1B4, 0xC, 0, 8, 2, 0 },
	{ { 0x29D5D7EC, 0x0, }, 0x2000, 0x80, 0x1000, 0xDA, 0x8, 0, 2, 2, 0 },
	{ { 0x2594D7AD, 0x0, }, 0x2000, 0x80, 0x1000, 0xE0, 0xC, 0, 3, 1, 0 },
	{ { 0x3294E798, 0x0, }, 0x1004, 0x80, 0x2000, 0x1C0, 0x10, 0, 1, 1, 0 },
	{ { 0x3294D798, 0x0, }, 0x1034, 0x80, 0x2000, 0x178, 0x8, 0, 1, 1, 0 },
	{ { 0x3295DE98, 0x0, }, 0x2068, 0x80, 0x2000, 0x178, 0x8, 0, 1, 2, 0 },
	{ { 0x3295EE98, 0x0, }, 0x2008, 0x80, 0x2000, 0x1C0, 0x18, 0, 1, 2, 0 },
	{ { 0x4604682C, 0x0, }, 0x1000, 0x100, 0x1000, 0xE0, 0xC, 0, 7, 1, 0 },
	{ { 0xC605882C, 0x0, }, 0x2000, 0x100, 0x1000, 0xE0, 0xE0, 0, 7, 2, 0 },
	{ { 0xCB05A82C, 0x0, }, 0x2000, 0x100, 0x2000, 0x1C0, 0x18, 0, 7, 2, 0 },
	{ { 0x4B04882C, 0x0, }, 0x1000, 0x100, 0x2000, 0x1C0, 0x18, 0, 7, 1, 0 },
	{ { 0x3295DE45, 0x0, }, 0x2000, 0x80, 0x2000, 0x178, 0x8, 0, 9, 2, 0 },
	{ { 0x32944845, 0x0, }, 0x1000, 0x80, 0x2000, 0x1C0, 0x8, 0, 9, 1, 0 },
	{ { 0x32956845, 0x0, }, 0x2000, 0x80, 0x2000, 0x1C0, 0x8, 0, 9, 2, 0 },
	{ { 0x82942D45, 0x0, }, 0x1000, 0x100, 0x2000, 0x280, 0x8, 0, 9, 1, 0 },
	{ { 0x82944D45, 0x0, }, 0x1000, 0x100, 0x2000, 0x280, 0x8, 0, 9, 1, 0 },
#endif
#ifdef CONFIG_MACH_IPOD_TOUCH_4G
	{ { 0x7A94D7EC, 0, }, 0x1038, 0x80, 0x2000, 0x280, 0x10, 0, 8, 1, 0 },
	{ { 0x7AD5DEEC, 0, }, 0x2070, 0x80, 0x2000, 0x280, 0x10, 0, 8, 2, 0 },
	{ { 0x7294D7EC, 0, }, 0x1038, 0x80, 0x2000, 0x1B4, 0xC, 0, 8, 1, 0 },
	{ { 0x72D5DEEC, 0, }, 0x2070, 0x80, 0x2000, 0x1B4, 0xC, 0, 8, 2, 0 },
	{ { 0x9A94D7AD, 0, }, 0x800, 0x100, 0x2000, 0x1C0, 0x18, 0, 8, 1, 0 },
	{ { 0x9A95DEAD, 0, }, 0x1000, 0x100, 0x2000, 0x1C0, 0x18, 0, 8, 2, 0 },
	{ { 0x3294E798, 0, }, 0x1004, 0x80, 0x2000, 0x1C0, 0x10, 0, 1, 1, 0 },
	{ { 0x3295EE98, 0, }, 0x2008, 0x80, 0x2000, 0x1C0, 0x18, 0, 1, 2, 0 },
	{ { 0xCB05A82C, 0, }, 0x2000, 0x100, 0x2000, 0x1C0, 0x18, 0, 7, 2, 0 },
	{ { 0x4B04882C, 0, }, 0x1000, 0x100, 0x2000, 0x1C0, 0x18, 0, 7, 1, 0 },
	{ { 0x32956845, 0, }, 0x2000, 0x80, 0x2000, 0x1C0, 8, 0, 9, 2, 0 },
#endif
#ifdef CONFIG_MACH_IPAD_1G
	{ { 0x7294D7EC, 0, }, 0x1038, 0x80, 0x2000, 0x1B4, 0xC, 0, 8, 1, 0 },
	{ { 0x72D5DEEC, 0, }, 0x2070, 0x80, 0x2000, 0x1B4, 0xC, 0, 8, 2, 0 },
	{ { 0xB614D5AD, 0, }, 0x1000, 0x80, 0x1000, 0x80, 4, 0, 3, 1, 0 },
	{ { 0x2594D7AD, 0, }, 0x2000, 0x80, 0x1000, 0xE0, 0xC, 0, 3, 1, 0 },
	{ { 0x3294E798, 0, }, 0x1004, 0x80, 0x2000, 0x1C0, 0x10, 0, 1, 1, 0 },
	{ { 0x3294D798, 0, }, 0x1034, 0x80, 0x2000, 0x178, 8, 0, 1, 1, 0 },
	{ { 0x3295DE98, 0, }, 0x2068, 0x80, 0x2000, 0x178, 8, 0, 1, 2, 0 },
	{ { 0x3295EE98, 0, }, 0x2008, 0x80, 0x2000, 0x1C0, 0x18, 0, 1, 2, 0 },
	{ { 0x4604682C, 0, }, 0x1000, 0x100, 0x1000, 0xE0, 0xC, 0, 7, 1, 0 },
#endif
#ifdef CONFIG_MACH_APPLETV_2G
	{ { 0x7294D7EC, 0, }, 0x1038, 0x80, 0x2000, 0x1B4, 0xC, 0, 8, 1, 0 },
	{ { 0x3294E798, 0, }, 0x1004, 0x80, 0x2000, 0x1C0, 0x10, 0, 1, 1, 0 },
#endif
};

static struct h2fmi_board_info h2fmi_board_info[] = {
#ifdef CONFIG_MACH_IPHONE_4
	{ { 2, 1, { 0x4604682C, 0x0 }, 4, { 0x0, 0x0, }, 0, }, 0x120014 },
	{ { 2, 1, { 0xC605882C, 0x0 }, 4, { 0x0, 0x0, }, 0, }, 0x120014 },
	{ { 2, 1, { 0xCB05A82C, 0x0 }, 4, { 0x0, 0x0, }, 0, }, 0x120014 },
	{ { 2, 1, { 0x3295DE98, 0x0 }, 4, { 0x0, 0x0, }, 0, }, 0x150011 },
	{ { 2, 1, { 0x3294D798, 0x0 }, 4, { 0x0, 0x0, }, 0, }, 0x150011 },
	{ { 2, 1, { 0x3294E798, 0x0 }, 4, { 0x0, 0x0, }, 0, }, 0x150011 },
	{ { 2, 1, { 0x3295EE98, 0x0 }, 4, { 0x0, 0x0, }, 0, }, 0x150011 },
	{ { 2, 1, { 0x3295EE98, 0x0 }, 8, { 0x0, 0x0, }, 0, }, 0x150011 },
	{ { 2, 1, { 0x2594D7AD, 0x0 }, 2, { 0x0, 0x0, }, 0, }, 0x100014 },
	{ { 2, 1, { 0x2594D7AD, 0x0 }, 4, { 0x0, 0x0, }, 0, }, 0x100014 },
	{ { 2, 1, { 0x29D5D7EC, 0x0 }, 4, { 0x0, 0x0, }, 0, }, 0x100014 },
	{ { 2, 1, { 0x7294D7EC, 0x0 }, 4, { 0x0, 0x0, }, 0, }, 0x100014 },
	{ { 2, 1, { 0x7294D7EC, 0x0 }, 2, { 0x0, 0x0, }, 0, }, 0x100014 },
	{ { 2, 1, { 0x72D5DEEC, 0x0 }, 4, { 0x0, 0x0, }, 0, }, 0x100014 },
	{ { 2, 1, { 0x72D5DEEC, 0x0 }, 8, { 0x0, 0x0, }, 0, }, 0x100014 },
	{ { 2, 1, { 0x7A94D7EC, 0x0 }, 4, { 0x0, 0x0, }, 0, }, 0x100014 },
	{ { 2, 1, { 0x7AD5DEEC, 0x0 }, 4, { 0x0, 0x0, }, 0, }, 0x100014 },
	{ { 2, 1, { 0x32944845, 0x0 }, 4, { 0x0, 0x0, }, 0, }, 0x150011 },
	{ { 2, 1, { 0x32956845, 0x0 }, 4, { 0x0, 0x0, }, 0, }, 0x150011 },
	{ { 2, 1, { 0x3295DE45, 0x0 }, 4, { 0x0, 0x0, }, 0, }, 0x150011 },
	{ { 2, 1, { 0x4B04882C, 0x0 }, 2, { 0x0, 0x0, }, 0, }, 0x120014 },
	{ { 2, 1, { 0x4B04882C, 0x0 }, 4, { 0x0, 0x0, }, 0, }, 0x120014 },
	{ { 2, 1, { 0x82942D45, 0x0 }, 2, { 0x0, 0x0, }, 0, }, 0x150011 },
	{ { 2, 1, { 0x82944D45, 0x0 }, 4, { 0x0, 0x0, }, 0, }, 0x150011 },
#endif
#ifdef CONFIG_MACH_IPOD_TOUCH_4G
	{ { 2, 1, { 0x7A94D7EC, 0, }, 2, { 0, 0, }, 0, }, 0x100014 },
	{ { 2, 1, { 0x7AD5DEEC, 0, }, 4, { 0, 0, }, 0, }, 0x100014 },
	{ { 2, 1, { 0x7294D7EC, 0, }, 2, { 0, 0, }, 0, }, 0x100014 },
	{ { 2, 1, { 0x7294D7EC, 0, }, 4, { 0, 0, }, 0, }, 0x100014 },
	{ { 2, 1, { 0x72D5DEEC, 0, }, 4, { 0, 0, }, 0, }, 0x100014 },
	{ { 2, 2, { 0x72D5DEEC, 0, }, 4, { 0x72D5DEEC, 0, }, 4, }, 0x100014 },
	{ { 2, 1, { 0x72D5DEEC, 0, }, 8, { 0, 0, }, 0, }, 0x100014 },
	{ { 2, 2, { 0x72D5DEEC, 0, }, 8, { 0x72D5DEEC, 0, }, 8, }, 0x100014 },
	{ { 2, 1, { 0x9A94D7AD, 0, }, 2, { 0, 0, }, 0, }, 0x100014 },
	{ { 2, 1, { 0x9A95DEAD, 0, }, 4, { 0, 0, }, 0, }, 0x100014 },
	{ { 2, 1, { 0x3295EE98, 0, }, 4, { 0, 0, }, 0, }, 0x150011 },
	{ { 2, 1, { 0x3294E798, 0, }, 4, { 0, 0, }, 0, }, 0x150011 },
	{ { 2, 1, { 0x3294E798, 0, }, 2, { 0, 0, }, 0, }, 0x150011 },
	{ { 2, 1, { 0x3295EE98, 0, }, 8, { 0, 0, }, 0, }, 0x150011 },
	{ { 2, 1, { 0x32956845, 0, }, 4, { 0, 0, }, 0, }, 0x150011 },
	{ { 2, 1, { 0xCB05A82C, 0, }, 4, { 0, 0, }, 0, }, 0x120014 },
	{ { 2, 1, { 0x4B04882C, 0, }, 4, { 0, 0, }, 0, }, 0x120014 },
#endif
#ifdef CONFIG_MACH_IPAD_1G
	{ { 2, 1, { 0x7294D7EC, 0, }, 2, { 0, 0, }, 0, }, 0x100014 },
	{ { 2, 2, { 0x7294D7EC, 0, }, 2, { 0x7294D7EC, 0, }, 2, }, 0x100014 },
	{ { 2, 2, { 0x7294D7EC, 0, }, 4, { 0x7294D7EC, 0, }, 4, }, 0x100014 },
	{ { 2, 2, { 0x72D5DEEC, 0, }, 4, { 0x72D5DEEC, 0, }, 4, }, 0x100014 },
	{ { 2, 1, { 0x4604682C, 0, }, 4, { 0, 0, }, 0 }, 0x120014 },
	{ { 2, 2, { 0x4604682C, 0, }, 4, { 0x4604682C, 0, }, 4, }, 0x120014 },
	{ { 2, 2, { 0x4604682C, 0, }, 2, { 0x4604682C, 0, }, 2, }, 0x120014 },
	{ { 2, 2, { 0x3294D798, 0, }, 2, { 0x3294D798, 0, }, 2, }, 0x150011 },
	{ { 2, 2, { 0x3294D798, 0, }, 4, { 0x3294D798, 0, }, 4, }, 0x150011 },
	{ { 2, 2, { 0x3295DE98, 0, }, 4, { 0x3295DE98, 0, }, 4, }, 0x150011 },
	{ { 2, 2, { 0x3294E798, 0, }, 4, { 0x3294E798, 0, }, 4, }, 0x150011 },
	{ { 2, 2, { 0x3294E798, 0, }, 2, { 0x3294E798, 0, }, 2, }, 0x150011 },
	{ { 2, 2, { 0x3295EE98, 0, }, 4, { 0x3295EE98, 0, }, 4, }, 0x150011 },
	{ { 2, 2, { 0x2594D7AD, 0, }, 2, { 0x2594D7AD, 0, }, 2, }, 0x100014 },
	{ { 1, 1, { 0xB614D5AD, 0, }, 4, { 0, 0, }, 0 }, 0x100014 },
	{ { 2, 1, { 0xB614D5AD, 0, }, 4, { 0, 0, }, 0 }, 0x100014 },
	{ { 2, 2, { 0xB614D5AD, 0, }, 4, { 0xB614D5AD, 0, }, 4, }, 0x100014 },
#endif
#ifdef CONFIG_MACH_APPLETV_2G
	{ { 2, 1, { 0x7294D7EC, 0, }, 2, { 0, 0, }, 0, }, 0x100014 },
	{ { 2, 2, { 0x7294D7EC, 0, }, 2, { 0x7294D7EC, 0, }, 2, }, 0x100014 },
	{ { 2, 1, { 0x3294E798, 0, }, 2, { 0, 0, }, 0, }, 0x150011 },
	{ { 2, 2, { 0x3294E798, 0, }, 2, { 0x3294E798, 0, }, 2, }, 0x150011 },
#endif
};

static struct h2fmi_timing_info h2fmi_timing_info[] = {
#ifdef CONFIG_MACH_IPHONE_4
	{ { 2, 1, { 0x7A94D7EC, 0x0, }, 4, { 0x0, 0x0, }, 0, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0xF, },
	{ { 2, 1, { 0x7AD5DEEC, 0x0, }, 4, { 0x0, 0x0, }, 0, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0xF, },
	{ { 2, 1, { 0x7294D7EC, 0x0, }, 2, { 0x0, 0x0, }, 0, }, 0x1E, 0xF, 0xA, 0x1E, 0xF, 0xA, 0x19, 0xF, },
	{ { 2, 1, { 0x7294D7EC, 0x0, }, 4, { 0x0, 0x0, }, 0, }, 0x1E, 0xF, 0xA, 0x1E, 0xF, 0xA, 0x19, 0xF, },
	{ { 2, 1, { 0x72D5DEEC, 0x0, }, 4, { 0x0, 0x0, }, 0, }, 0x1E, 0xF, 0xA, 0x1E, 0xF, 0xA, 0x14, 0xF, },
	{ { 2, 1, { 0x72D5DEEC, 0x0, }, 8, { 0x0, 0x0, }, 0, }, 0x1E, 0xF, 0xA, 0x1E, 0xF, 0xA, 0x19, 0xF, },
	{ { 2, 1, { 0x29D5D7EC, 0x0, }, 4, { 0x0, 0x0, }, 0, }, 0x1E, 0xF, 0xA, 0x1E, 0xF, 0xA, 0x14, 0xF, },
	{ { 2, 1, { 0x2594D7AD, 0x0, }, 4, { 0x0, 0x0, }, 0, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0xF, },
	{ { 2, 1, { 0x2594D7AD, 0x0, }, 4, { 0x0, 0x0, }, 0, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0xF, },
	{ { 2, 1, { 0x2594D7AD, 0x0, }, 2, { 0x0, 0x0, }, 0, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0xF, },
	{ { 2, 1, { 0x3294D798, 0x0, }, 4, { 0x0, 0x0, }, 0, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0x19, },
	{ { 2, 1, { 0x3295DE98, 0x0, }, 4, { 0x0, 0x0, }, 0, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0x19, },
	{ { 2, 1, { 0x3294E798, 0x0, }, 4, { 0x0, 0x0, }, 0, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0x19, },
	{ { 2, 1, { 0x3295EE98, 0x0, }, 4, { 0x0, 0x0, }, 0, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0x19, },
	{ { 2, 1, { 0x3295EE98, 0x0, }, 8, { 0x0, 0x0, }, 0, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0x19, },
	{ { 2, 1, { 0x4604682C, 0x0, }, 4, { 0x0, 0x0, }, 0, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0xF, },
	{ { 2, 1, { 0xC605882C, 0x0, }, 4, { 0x0, 0x0, }, 0, }, 0x14, 0xA, 0x7, 0x14, 0xA, 0x7, 0x10, 0xF, },
	{ { 2, 1, { 0xCB05A82C, 0x0, }, 4, { 0x0, 0x0, }, 0, }, 0x14, 0xA, 0x7, 0x14, 0xA, 0x7, 0x10, 0xF, },
	{ { 2, 1, { 0x4B04882C, 0x0, }, 2, { 0x0, 0x0, }, 0, }, 0x14, 0xA, 0x7, 0x14, 0xA, 0x7, 0x10, 0xF, },
	{ { 2, 1, { 0x4B04882C, 0x0, }, 4, { 0x0, 0x0, }, 0, }, 0x14, 0xA, 0x7, 0x14, 0xA, 0x7, 0x10, 0xF, },
	{ { 2, 1, { 0x3295DE45, 0x0, }, 4, { 0x0, 0x0, }, 0, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0x1E, },
	{ { 2, 1, { 0x32944845, 0x0, }, 4, { 0x0, 0x0, }, 0, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0x19, },
	{ { 2, 1, { 0x32956845, 0x0, }, 4, { 0x0, 0x0, }, 0, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0x19, },
	{ { 2, 1, { 0x82942D45, 0x0, }, 2, { 0x0, 0x0, }, 0, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0x19, },
	{ { 2, 1, { 0x82944D45, 0x0, }, 4, { 0x0, 0x0, }, 0, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0x19, },
#endif
#ifdef CONFIG_MACH_IPOD_TOUCH_4G
	{ { 2, 1, { 0x7A94D7EC, 0, }, 2, { 0, 0, }, 0, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0xF },
	{ { 2, 1, { 0x7AD5DEEC, 0, }, 4, { 0, 0, }, 0, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0xF },
	{ { 2, 1, { 0x7294D7EC, 0, }, 2, { 0, 0, }, 0, }, 0x1E, 0xF, 0xA, 0x1E, 0xF, 0xA, 0x19, 0xF },
	{ { 2, 1, { 0x7294D7EC, 0, }, 4, { 0, 0, }, 0, }, 0x1E, 0xF, 0xA, 0x1E, 0xF, 0xA, 0x19, 0xF },
	{ { 2, 1, { 0x72D5DEEC, 0, }, 4, { 0, 0, }, 0, }, 0x1E, 0xF, 0xA, 0x1E, 0xF, 0xA, 0x14, 0xF },
	{ { 2, 2, { 0x72D5DEEC, 0, }, 4, { 0x72D5DEEC, 0, }, 4, }, 0x1E, 0xF, 0xA, 0x1E, 0xF, 0xA, 0x14, 0xF },
	{ { 2, 1, { 0x72D5DEEC, 0, }, 8, { 0, 0, }, 0, }, 0x1E, 0xF, 0xA, 0x1E, 0xF, 0xA, 0x19, 0xF },
	{ { 2, 2, { 0x72D5DEEC, 0, }, 8, { 0x72D5DEEC, 0, }, 8, }, 0x1E, 0xF, 0xA, 0x1E, 0xF, 0xA, 0x19, 0xF },
	{ { 2, 1, { 0x9A94D7AD, 0, }, 2, { 0, 0, }, 0, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0xF },
	{ { 2, 1, { 0x9A95DEAD, 0, }, 4, { 0, 0, }, 0, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0xF },
	{ { 2, 1, { 0x3294E798, 0, }, 4, { 0, 0, }, 0, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0x19 },
	{ { 2, 1, { 0x3295EE98, 0, }, 4, { 0, 0, }, 0, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0x19 },
	{ { 2, 1, { 0x3295EE98, 0, }, 8, { 0, 0, }, 0, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0x19 },
	{ { 2, 1, { 0x3294E798, 0, }, 2, { 0, 0, }, 0, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0x19 },
	{ { 2, 1, { 0xCB05A82C, 0, }, 4, { 0, 0, }, 0, }, 0x14, 0xA, 7, 0x14, 0xA, 7, 0x10, 0xF },
	{ { 2, 1, { 0x4B04882C, 0, }, 4, { 0, 0, }, 0, }, 0x14, 0xA, 7, 0x14, 0xA, 7, 0x10, 0xF },
	{ { 2, 1, { 0x32956845, 0, }, 4, { 0, 0, }, 0, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0x19 },
#endif
#ifdef CONFIG_MACH_IPAD_1G
	{ { 2, 1, { 0x7294D7EC, 0, }, 2, { 0, 0, }, 0, }, 0x1E, 0xF, 0xA, 0x1E, 0xF, 0xA, 0x19, 0xF },
	{ { 2, 2, { 0x7294D7EC, 0, }, 2, { 0x7294D7EC, 0, }, 2, }, 0x1E, 0xF, 0xA, 0x1E, 0xF, 0xA, 0x19, 0xF },
	{ { 2, 2, { 0x7294D7EC, 0, }, 4, { 0x7294D7EC, 0, }, 4, }, 0x1E, 0xF, 0xA, 0x1E, 0xF, 0xA, 0x19, 0xF },
	{ { 2, 2, { 0x72D5DEEC, 0, }, 4, { 0x72D5DEEC, 0, }, 4, }, 0x1E, 0xF, 0xA, 0x1E, 0xF, 0xA, 0x14, 0xF },
	{ { 2, 2, { 0x2594D7AD, 0, }, 2, { 0x2594D7AD, 0, }, 2, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0xF },
	{ { 1, 1, { 0xB614D5AD, 0, }, 4, { 0, 0, }, 0, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0xF },
	{ { 2, 1, { 0xB614D5AD, 0, }, 4, { 0, 0, }, 0, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0xF },
	{ { 2, 2, { 0xB614D5AD, 0, }, 4, { 0xB614D5AD, 0, }, 4, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0xF },
	{ { 2, 2, { 0x3294D798, 0, }, 2, { 0x3294D798, 0, }, 2, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0x19 },
	{ { 2, 2, { 0x3294D798, 0, }, 4, { 0x3294D798, 0, }, 4, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0x19 },
	{ { 2, 2, { 0x3295DE98, 0, }, 4, { 0x3295DE98, 0, }, 4, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0x19 },
	{ { 2, 2, { 0x3294E798, 0, }, 2, { 0x3294E798, 0, }, 2, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0x19 },
	{ { 2, 2, { 0x3294E798, 0, }, 4, { 0x3294E798, 0, }, 4, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0x19 },
	{ { 2, 2, { 0x3295EE98, 0, }, 4, { 0x3295EE98, 0, }, 4, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0x19 },
	{ { 2, 1, { 0x4604682C, 0, }, 4, { 0, 0, }, 0, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0xF },
	{ { 2, 2, { 0x4604682C, 0, }, 4, { 0x4604682C, 0, }, 4, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0xF },
	{ { 2, 2, { 0x4604682C, 0, }, 2, { 0x4604682C, 0, }, 2, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0xF },
#endif
#ifdef CONFIG_MACH_APPLETV_2G
	{ { 2, 1, { 0x7294D7EC, 0, }, 2, { 0, 0, }, 0, }, 0x1E, 0xF, 0xA, 0x1E, 0xF, 0xA, 0x19, 0xF },
	{ { 2, 2, { 0x7294D7EC, 0, }, 2, { 0x7294D7EC, 0, }, 2, }, 0x1E, 0xF, 0xA, 0x1E, 0xF, 0xA, 0x19, 0xF },
	{ { 2, 2, { 0x3294E798, 0, }, 2, { 0x3294E798, 0, }, 2, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0x19 },
	{ { 2, 1, { 0x3294E798, 0, }, 2, { 0, 0, }, 0, }, 0x19, 0xC, 0xA, 0x19, 0xC, 0xA, 0x14, 0x19 },
#endif
};

#if defined(CONFIG_MACH_IPHONE_4)
static struct h2fmi_smth h2fmi_smth_i4 = { { 0, 0, 0, 3, 4, 3, 4, 0 }, { 0xF0F, 0, 0 } };
#endif
#if defined(CONFIG_MACH_IPAD_1G)
static struct h2fmi_smth h2fmi_smth_ipad = { { 0, 0, 0, 3, 3, 4, 4, 0 }, { 0x3333, 0xCCCC, 0 } };
#endif
#if defined(CONFIG_MACH_IPOD_TOUCH_4G)
static struct h2fmi_smth h2fmi_smth_ipt4g = { { 0, 0, 0, 5, 5, 5, 5, 0 }, { 0x3333, 0xCCCC, 0 } };
#endif
#if defined(CONFIG_MACH_APPLETV_2G)
static struct h2fmi_smth h2fmi_smth_atv2g = { { 0, 0, 0, 3, 3, 3, 4, 0 }, { 0x3333, 0xCCCC, 0 } };
#endif

static int count_bits(u32 _val)
{
	int ret = 0;

	while(_val > 0)
	{
		if(_val & 1)
			ret++;
		
		_val >>= 1;
	}

	return ret;
}

static struct h2fmi_platform_data pdata0;
static struct h2fmi_platform_data pdata1;

static int h2fmi_complete_board_id(int _idx, u8 _chip_id[8], int _bitmap, struct h2fmi_board_id *_id)
{
	static int num_waiting = 0;
	static int bitmap = 0;
	static int count = 0;
	static struct h2fmi_board_id id;
	static DECLARE_COMPLETION(cpl);

	bitmap |= (_bitmap << (_idx*8));
	count += count_bits(_bitmap);

	if(++num_waiting >= 2)
	{
		printk("%s: victory\n", __func__);
		memset(&id, 0, sizeof(id));
		id.num_busses = 2;

		// Calculate num_symmetric
		{
			int i = 0;
			u32 mask = pdata0.smth->symmetric_masks[0];
			int bit_count = count_bits(bitmap & mask);
			while(mask)
			{
				u32 bits = bitmap & mask;
				if(bits)
				{
					if(count_bits(bits) != bit_count)
					{
						printk(KERN_ERR "h2fmi: chip IDs not symmetric.");
						break;
					}

					id.num_symmetric++;
				}
				
				i++;
				mask = pdata0.smth->symmetric_masks[i];
			}

			if(id.num_symmetric > 0)
			{
				memcpy(&id.chipID, _chip_id, 4);
				id.chip1_count = count/id.num_symmetric;
			}

			if(id.num_symmetric > 1)
			{
				memcpy(&id.chipID2, _chip_id, 4);
				id.chip2_count = count/id.num_symmetric;
			}
		}

		memcpy(_id, &id, sizeof(id));
		complete(&cpl);
	}
	else
	{
		printk("%s\n", __func__);
		wait_for_completion(&cpl);
		memcpy(_id, &id, sizeof(id));
	}

	return 0;
}

static inline int compare_board_id(struct h2fmi_board_id *_a, struct h2fmi_board_id *_b)
{
	return memcmp(_a, _b, sizeof(*_a));
}

static struct h2fmi_chip_info *h2fmi_find_chip(u8 _chip_id[8])
{
	int i;

	for(i = 0; i < ARRAY_SIZE(h2fmi_chip_info); i++)
	{
		if(memcmp(&h2fmi_chip_info[i], _chip_id, 4) == 0)
			return &h2fmi_chip_info[i];
	}

	return NULL;
}

static struct h2fmi_board_info *h2fmi_find_board(struct h2fmi_board_id *_id)
{
	int i;
	for(i = 0; i < ARRAY_SIZE(h2fmi_board_info); i++)
	{
		if(compare_board_id(&h2fmi_board_info[i].board_id, _id) == 0)
			return &h2fmi_board_info[i];
	}

	return NULL;
}

static struct h2fmi_timing_info *h2fmi_find_timing(struct h2fmi_board_id *_id)
{
	int i;
	for(i = 0; i < ARRAY_SIZE(h2fmi_timing_info); i++)
	{
		if(compare_board_id(&h2fmi_timing_info[i].board_id, _id) == 0)
			return &h2fmi_timing_info[i];
	}

	return NULL;
}

static struct h2fmi_platform_data pdata0 = {
	.ecc_step_shift = 10,

	.dma0 = 4,
	.dma1 = 5,

	.pid0 = 1,
	.pid1 = 2,

	.complete_board_id = h2fmi_complete_board_id,
	.find_chip = h2fmi_find_chip,
	.find_board = h2fmi_find_board,
	.find_timing = h2fmi_find_timing,
};

static struct h2fmi_platform_data pdata1 = {
	.ecc_step_shift = 10,

	.dma0 = 6,
	.dma1 = 7,

	.pid0 = 3,
	.pid1 = 4,

	.complete_board_id = h2fmi_complete_board_id,
	.find_chip = h2fmi_find_chip,
	.find_board = h2fmi_find_board,
	.find_timing = h2fmi_find_timing,
};

static struct platform_device h2fmi0 = {
	.name = "apple-h2fmi",
	.id = 0,

	.resource = h2fmi0_res,
	.num_resources = ARRAY_SIZE(h2fmi0_res),

	.dev = {
		.platform_data = &pdata0,
		.coherent_dma_mask = DMA_32BIT_MASK,
	},
};

static struct platform_device h2fmi1 = {
	.name = "apple-h2fmi",
	.id = 1,

	.resource = h2fmi1_res,
	.num_resources = ARRAY_SIZE(h2fmi1_res),

	.dev = {
		.platform_data = &pdata1,
		.coherent_dma_mask = DMA_32BIT_MASK,
	},
};

int s5l8930_register_h2fmi(void)
{
	int ret;

#ifdef CONFIG_MACH_IPHONE_4
	if(machine_is_iphone_4())
	{
		pdata0.smth = &h2fmi_smth_i4;
		pdata1.smth = &h2fmi_smth_i4;
	}
#endif

#ifdef CONFIG_MACH_IPAD_1G
	if(machine_is_ipad_1g())
	{
		pdata0.smth = &h2fmi_smth_ipad;
		pdata1.smth = &h2fmi_smth_ipad;
	}
#endif

#ifdef CONFIG_MACH_IPOD_TOUCH_4G
	if(machine_is_ipod_touch_4g())
	{
		pdata0.smth = &h2fmi_smth_ipt4g;
		pdata1.smth = &h2fmi_smth_ipt4g;
	}
#endif

#ifdef CONFIG_MACH_APPLETV_2G
	if(machine_is_appletv_2g())
	{
		pdata0.smth = &h2fmi_smth_atv2g;
		pdata1.smth = &h2fmi_smth_atv2g;
	}
#endif

	ret = platform_device_register(&h2fmi0);
	if(ret)
		return ret;

	return platform_device_register(&h2fmi1);
}
